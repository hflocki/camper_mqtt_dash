<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camper Dashboard - Status</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="./style.css"> 
  <script src="./mqtt.min.js"></script> 
  <script src="./config.js"></script> 
  <link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(registration => {
          console.log('Service Worker registriert: ', registration.scope);
        }).catch(err => {
          console.log('Service Worker Registrierung fehlgeschlagen: ', err);
        });
      });
    }
</script>
</head>
<body>

<nav class="navbar">
      <img id="navLogo" src="./imag/felix.png" alt="Logo" class="nav-logo">
    
    <h2 id="appTitle">Camper Status</h2> 
    <a href="control.html" class="nav-button">Zur Steuerung</a>
</nav>

  <div class="container">
    
    <div class="system-status-container">
        <div class="mqtt-status-group" style="display: flex; align-items: center; gap: 5px; margin-right: 30px; font-size: 1em; color: #333; font-weight: 600;">
            <div id="mqttLed" class="status-led" style="margin-top: 0;"></div>
            <span>MQTT:</span>
            <span id="mqttStatusLabel" style="color: #555; font-weight: normal;">Verbinden...</span>
        </div>
      
      <div class="status-item">
        <div id="heaterLed" class="status-led"></div>
        <div class="status-label">Heizung</div>
      </div>
      <div class="status-item">
        <div id="gpsLed" class="status-led"></div>
        <div class="status-label">GPS/Lage</div>
      </div>
      <div class="status-item">
        <div id="maxxFanLed" class="status-led"></div>
        <div class="status-label">MaxxFan</div>
      </div>
      <div class="status-item">
        <div id="tempLed" class="status-led"></div>
        <div class="status-label">Temperatur</div>
      </div>
      <div class="status-item">
        <div id="waterLed" class="status-led"></div>
        <div class="status-label">Wasserstand</div>
      </div>
       <div class="status-item">
        <div id="cpLed" class="status-led"></div>
        <div class="status-label">CP Plus</div>
      </div>
    </div>
    
    <div class="data-card">
        
      <div class="data-item">
        <h3><i class="fas fa-compass"></i> Orientierung</h3>
        <p>Roll (Quer): <span id="rollValue">N/A</span> °</p>
        <p>Pitch (Längs): <span id="pitchValue">N/A</span> °</p>
      </div>

      <div class="data-item">
        <h3><a href="#" id="mapLink" class="map-icon" target="_blank" title="Position auf Karte">
        <i class="fas fa-map-pin"></i> Position</a></h3>
        <p>
            LON: <span id="lonValue">N/A</span>   |  
            LAT: <span id="latValue">N/A</span>
        </p>
        <p>
            ALT: <span id="altValue">N/A</span> m   |  
            Geschw.: <span id="speedValue">N/A</span> km/h
        </p>
        <!-- <p><a href="#" id="mapLink" target="_blank" class="control-btn btn-primary small">Position auf Karte</a></p> -->
      </div>

      <div class="data-item">
        <h3><i class="fas fa-fire"></i> Heizung</h3>
        <p>Sollwert: <span id="setpointValue">N/A</span> °C</p>
        <p>Istwert: <span id="currentValue">N/A</span> °C</p>
      </div>
      
      <div class="data-item">
        <h3><i class="fas fa-home"></i> Innenraum</h3>
        <p>Temperatur: <span id="temperatureValue">N/A</span> °C</p>
        <p>Luftfeuchte: <span id="humidityValue">N/A</span> %</p>
      </div>
      
      <div class="data-item">
        <h3><i class="fas fa-fan"></i> MaxxFan</h3>
        <p>
            Lüfter Status: <span id="fanStateValue">N/A</span>   |  
            Lid Status: <span id="lidStateValue">N/A</span>
        </p>
        <p>
            Richtung: <span id="directionValue">N/A</span>   |  
            Auto-Modus: <span id="autoStateValue">N/A</span></p>
      </div>

    <div class="data-item">
        <h3><i class="fas fa-tint"></i> Frischwassertank</h3>
        <div class="water-container">
            <div class="water-tank">
                <p>Füllstand</p>
                <div class="water-bar-shell">
                    <div id="freshWaterBar" class="water-bar fresh-color" style="height: 0%;"></div>
                </div>
                <div id="freshWaterValue" class="value-label">-- %</div>
            </div>
            </div>
    </div>
</div>

<script>
    let client;
    let clientId = "webClient_" + Math.random().toString(16).substr(2, 8); 
    
    let currentLat = 'N/A';
    let currentLon = 'N/A';

    const mqttLedElement = document.getElementById('mqttLed');
    const mqttStatusLabelElement = document.getElementById('mqttStatusLabel');
    const mapLinkElement = document.getElementById('mapLink'); 
    
    // Mapping der Status-Topics zu den LEDs
    const ledMap = {
        [HEATER_STATE_TOPIC]: 'heaterLed',
        [ESPGEOPOS_STATE_TOPIC]: 'gpsLed',
        [MAXXFAN_STATE_TOPIC]: 'maxxFanLed',
        [ESPTEMP_STATE_TOPIC]: 'tempLed',
        [WATERFILL_STATE_TOPIC]: 'waterLed',
        [CP_PLUS_ALIVE_TOPIC]: 'cpLed'
    };

    // Funktion zum Aktualisieren des Karten-Links
    function updateMapLink() {
        if (currentLat !== 'N/A' && currentLon !== 'N/A') {
            // Fiktiver Link-Platzhalter
            mapLinkElement.href = `http://maps.google.com/maps?q=${currentLat},${currentLon}`;
            mapLinkElement.style.display = 'inline-block';
        } else {
             mapLinkElement.style.display = 'none';
        }
    }
    
    // --- Verbindung herstellen ---
    function connectClient() {
        const connectUrl = `ws://${WS_HOST}:${WS_PORT}`;
        console.log(`Versuche Verbindung zu ${connectUrl}`); 
        mqttStatusLabelElement.textContent = "Verbinden...";
        mqttLedElement.className = "status-led"; // Setzt auf grau
        
        client = mqtt.connect(connectUrl, {
            clientId: clientId,
            username: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            clean: true,
        });

        client.on('connect', function () {
            console.log("Verbunden!");
            mqttStatusLabelElement.textContent = "OK"; 
            mqttLedElement.className = "status-led status-led-online"; // Grün
            
            // Abonnements (alle Topics aus config.js)
            for (const topic in ledMap) {
                if (ledMap.hasOwnProperty(topic)) {
                    client.subscribe(topic, { qos: 0 });
                }
            }
            client.subscribe(HEATER_SETPOINT_TOPIC, { qos: 0 });
            client.subscribe(HEATER_CURRENT_TOPIC, { qos: 0 });
            client.subscribe(GPS_TEMP_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_HUMIDITY_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_PITCH_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_ROLL_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_LAT_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_LON_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_ALT_TOPIC, { qos: 0 }); 
            client.subscribe(GPS_SPEED_TOPIC, { qos: 0 }); 
            client.subscribe(MAXXFAN_FAN_STATE_TOPIC, { qos: 0 });
            client.subscribe(MAXXFAN_LID_STATE_TOPIC, { qos: 0 });
            client.subscribe(MAXXFAN_DIRECTION_TOPIC, { qos: 0 });
            client.subscribe(MAXXFAN_AUTO_STATE_TOPIC, { qos: 0 }); 
            client.subscribe(MAXXFAN_CEILING_STATE_TOPIC, { qos: 0 }); 
            client.subscribe(FRESH_WATER_STATE_TOPIC, { qos: 0 });
            console.log("Alle Topics abonniert.");
        });

        client.on('message', function (topic, message) {
            const payload = message.toString();
            
            // Aktualisiere LEDs basierend auf LWT (Online/Offline)
            if (ledMap.hasOwnProperty(topic)) {
                const ledElement = document.getElementById(ledMap[topic]);
                if (ledElement) {
                    // Verwende die korrekten Farbklassen
                    const isOnline = (payload === 'online' || payload === 'ON' || payload === 'True');
                    ledElement.className = `status-led ${isOnline ? 'status-led-online' : 'status-led-offline'}`; 
                }
            }
            
            if (topic === FRESH_WATER_STATE_TOPIC) {
                    // Der Payload ist der Wert in % (z.B. "55.0")
                    const level = parseFloat(payload).toFixed(0); 
                    
                    document.getElementById('freshWaterValue').textContent = `${level} %`;
                    document.getElementById('freshWaterBar').style.height = `${level}%`;
                    
                    // Füge einen Warnhinweis hinzu, wenn der Tank fast leer ist
                    const valueElement = document.getElementById('freshWaterValue');
                    if (level < 15) {
                        valueElement.style.color = 'red';
                    } else {
                        valueElement.style.color = '#333'; // Normale Farbe (oder was in style.css definiert ist)
                    }
                }

            // Aktualisiere Sensorwerte
            switch (topic) {
                case GPS_TEMP_TOPIC: document.getElementById('temperatureValue').textContent = parseFloat(payload).toFixed(1); break; 
                case GPS_HUMIDITY_TOPIC: document.getElementById('humidityValue').textContent = parseFloat(payload).toFixed(1); break; 
                case HEATER_SETPOINT_TOPIC: document.getElementById('setpointValue').textContent = parseFloat(payload).toFixed(1); break;
                case HEATER_CURRENT_TOPIC: document.getElementById('currentValue').textContent = parseFloat(payload).toFixed(1); break;
                case MAXXFAN_FAN_STATE_TOPIC: document.getElementById('fanStateValue').textContent = payload; break;
                case MAXXFAN_LID_STATE_TOPIC: document.getElementById('lidStateValue').textContent = payload; break;
                case MAXXFAN_DIRECTION_TOPIC: document.getElementById('directionValue').textContent = payload; break;
                case MAXXFAN_AUTO_STATE_TOPIC: document.getElementById('autoStateValue').textContent = payload; break;
                case GPS_LON_TOPIC: 
                    currentLon = parseFloat(payload).toFixed(4);
                    document.getElementById('lonValue').textContent = currentLon; 
                    updateMapLink(); 
                    break;
                case GPS_LAT_TOPIC: 
                    currentLat = parseFloat(payload).toFixed(4);
                    document.getElementById('latValue').textContent = currentLat; 
                    updateMapLink(); 
                    break;
                case GPS_ALT_TOPIC: document.getElementById('altValue').textContent = parseFloat(payload).toFixed(1); break; 
                case GPS_SPEED_TOPIC: document.getElementById('speedValue').textContent = parseFloat(payload).toFixed(0); break; 
                case GPS_ROLL_TOPIC: document.getElementById('rollValue').textContent = parseFloat(payload).toFixed(1); break; 
                case GPS_PITCH_TOPIC: document.getElementById('pitchValue').textContent = parseFloat(payload).toFixed(1); break; 
            }
        });

        client.on('error', function (err) {
            console.error("Verbindung fehlgeschlagen (Client Error): ", err);
            mqttStatusLabelElement.textContent = "FEHLER"; 
            mqttLedElement.className = "status-led status-led-offline"; // Rot
        });

        client.on('close', function () {
            console.log("Verbindung geschlossen/verloren. Versuche Wiederverbindung...");
            mqttStatusLabelElement.textContent = "Verloren"; 
            mqttLedElement.className = "status-led status-led-offline"; // Rot
        });

        client.on('offline', function () {
            console.log("Client ist offline.");
            mqttStatusLabelElement.textContent = "Offline"; 
            mqttLedElement.className = "status-led status-led-offline"; // Rot
        });
    }

    // Starten der Verbindung beim Laden der Seite
    document.addEventListener('DOMContentLoaded', connectClient);
</script>
</body>
</html>
