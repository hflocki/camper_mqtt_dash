<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camper Dashboard - Steuerung</title>
  
  <link rel="stylesheet" href="./style.css"> 
  <script src="./mqtt.min.js"></script>
  <script src="./config.js"></script> 
  <link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(registration => {
          console.log('Service Worker registriert: ', registration.scope);
        }).catch(err => {
          console.log('Service Worker Registrierung fehlgeschlagen: ', err);
        });
      });
    }
</script>
</head>
<body>
<nav class="navbar">
    <img id="navLogo" src="./imag/felix.png" alt="Logo" class="nav-logo">
    
    <h2 id="appTitle">Camper Steuerung</h2> 
    <a href="index.html" class="nav-button">Zum Status</a>
</nav>

  <div class="container">
    
    <div class="system-status-container">
        <div class="mqtt-status-group" style="display: flex; align-items: center; gap: 5px; margin-right: 30px; font-size: 1em; color: #333; font-weight: 600;">
            <div id="mqttLed" class="status-led" style="margin-top: 0;"></div>
            <span>MQTT:</span>
            <span id="mqttStatusLabel" style="color: #555; font-weight: normal;">Verbinden...</span>
        </div>
      
        <div class="status-item">
            <div id="heaterLed" class="status-led"></div>
            <div class="status-label">Heizung</div>
        </div>
        <div class="status-item">
            <div id="gpsLed" class="status-led"></div>
            <div class="status-label">GPS/Lage</div>
        </div>
        <div class="status-item">
            <div id="maxxFanLed" class="status-led"></div>
            <div class="status-label">MaxxFan</div>
        </div>
        <div class="status-item">
            <div id="tempLed" class="status-led"></div>
            <div class="status-label">Temp/Licht</div>
        </div>
        <div class="status-item">
            <div id="waterLed" class="status-led"></div>
            <div class="status-label">Wasser</div>
        </div>
        
    </div>

    
    <div class="data-card">
        
        <div class="data-item">
            <h3>Beleuchtung</h3>
            <p>Hauptlicht:</p>
            <button class="btn btn-on" id="btnMainLightOn">AN</button>
            <button class="btn btn-off" id="btnMainLightOff">AUS</button>
        </div>

        <div class="data-item">
            <h3>Heizung</h3>
            <p>Zieltemperatur (&deg;C):</p>
            <input type="number" id="tempSetpoint" value="20.0" step="0.5" min="10" max="30" class="input-field">
            <button class="btn btn-action" id="btnSetTemp">Setzen</button>
            
            <div class="temp-preset-buttons">
                <button class="btn btn-preset" data-temp="17">17&deg;C</button>
                <button class="btn btn-preset" data-temp="19">19&deg;C</button>
                <button class="btn btn-preset" data-temp="21">21&deg;C</button>
                <button class="btn btn-preset" data-temp="23">23&deg;C</button>
                <button class="btn btn-preset" data-temp="26">26&deg;C</button>
                <button class="btn btn-preset" data-temp="28">28&deg;C</button>
            </div>
        </div>
        
        <div class="data-item">
            <h3>MaxxFan Steuerung</h3>
            <p>Auto-Modus:</p>
            <label class="switch">
                <input type="checkbox" id="switchAutoFan" class="switch-input">
                <span class="slider round"></span>
            </label>
            <p style="margin-top: 15px;">Dach-Ventilator:</p>
            <label class="switch">
                <input type="checkbox" id="switchCeilingMode" class="switch-input">
                <span class="slider round"></span>
            </label>
        </div>
        
        <div class="data-item system-restart-box">
            <h3>System Neustart</h3>
            <p>Alle Komponenten:</p>
            <button class="btn btn-restart" id="btnRestartHeater">Heizung</button>
            <button class="btn btn-restart" id="btnRestartFan">MaxxFan</button>
            <button class="btn btn-restart" id="btnRestartGps">GPS/Lage</button>
            <button class="btn btn-restart" id="btnRestartTemp">Temp/Licht</button>
            <button class="btn btn-restart" id="btnRestartWater">Wasser</button>
        </div>
        
    </div>
    
  </div>


<script>
    // --- MQTT Logik ---
    let client;
    const mqttStatusLabelElement = document.getElementById('mqttStatusLabel');
    const mqttLedElement = document.getElementById('mqttLed');
    const switchAutoFan = document.getElementById('switchAutoFan');
    const switchCeilingMode = document.getElementById('switchCeilingMode');
    
    // Sendet einen Befehl über MQTT
    function sendCommand(topic, payload) {
        if (client && client.connected) {
            client.publish(topic, payload.toString(), { qos: 0, retain: false });
            console.log(`Befehl gesendet: ${payload} an ${topic}`);
        } else {
            console.warn("MQTT nicht verbunden. Befehl konnte nicht gesendet werden.");
        }
    }

    // Zeigt den Status der Status-LEDs an
    function updateLedStatus(elementId, payload) {
        const ledElement = document.getElementById(elementId + 'Led');
        if (ledElement) {
            const isOnline = payload.toUpperCase() === 'ONLINE';
            ledElement.className = isOnline ? 'status-led status-led-online' : 'status-led status-led-offline';
        }
    }

    // Setzt den Zustand eines Schalters
    function setSwitchState(switchElement, payload) {
        const isChecked = payload.toUpperCase() === 'ON' || payload.toUpperCase() === 'TRUE';
        switchElement.checked = isChecked;
    }

    // Funktion zum Einrichten der Neustart-Buttons (OHNE CONFIRM)
    function setupRestartButton(buttonId, topic, nodeName) {
        document.getElementById(buttonId).onclick = function() {
            if (client && client.connected) {
                client.publish(topic, "", { qos: 0, retain: false }); 
                console.log(`Neustart-Befehl gesendet an ${topic} (Gerät: ${nodeName})`);
            } else {
                console.warn("MQTT nicht verbunden. Kann Neustart-Befehl nicht senden.");
                alert(`MQTT nicht verbunden. Kann Neustart-Befehl für ${nodeName} nicht senden.`);
            }
        };
    }

    // Verarbeitet eingehende MQTT-Nachrichten
    function onMessage(topic, message) {
        const payload = message.toString().toUpperCase();

        switch (topic) {
            // --- LWT Status ---
            case HEATER_STATE_TOPIC: updateLedStatus('heater', payload); break;
            case ESPGEOPOS_STATE_TOPIC: updateLedStatus('gps', payload); break;
            case MAXXFAN_STATE_TOPIC: updateLedStatus('maxxFan', payload); break;
            case ESPTEMP_STATE_TOPIC: updateLedStatus('temp', payload); break;
            case WATERFILL_STATE_TOPIC: updateLedStatus('water', payload); break;
            
            // --- MaxxFan Status ---
            case MAXXFAN_AUTO_STATE_TOPIC: setSwitchState(switchAutoFan, payload); break;
            case MAXXFAN_CEILING_STATE_TOPIC: setSwitchState(switchCeilingMode, payload); break;
            
            default:
                break;
        }
    }
    
    // Stellt die MQTT-Verbindung her und abonniert Topics
    function connectClient() {
        const clientId = "webClient_control_" + Math.random().toString(16).substr(2, 8);
        const connectUrl = `ws://${WS_HOST}:${WS_PORT}${WS_PATH}`;

        client = mqtt.connect(connectUrl, {
            clientId: clientId,
            username: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            clean: true,
        });

        client.on('connect', function () {
            console.log("MQTT Broker verbunden!");
            mqttStatusLabelElement.textContent = "Verbunden (OK)";
            mqttLedElement.className = "status-led status-led-online"; 

            client.subscribe([
                HEATER_STATE_TOPIC, ESPGEOPOS_STATE_TOPIC, MAXXFAN_STATE_TOPIC, ESPTEMP_STATE_TOPIC, WATERFILL_STATE_TOPIC,
                MAXXFAN_AUTO_STATE_TOPIC, MAXXFAN_CEILING_STATE_TOPIC
            ], { qos: 0 });
            console.log("Status-Topics abonniert.");
        });

        client.on('message', onMessage); 

        client.on('error', function (err) {
            console.error("Verbindung fehlgeschlagen (Client Error): ", err);
            mqttStatusLabelElement.textContent = "FEHLER"; 
            mqttLedElement.className = "status-led status-led-offline"; 
        });

        client.on('close', function () {
            console.log("Verbindung geschlossen/verloren. Versuche Wiederverbindung...");
            mqttStatusLabelElement.textContent = "Verloren"; 
            mqttLedElement.className = "status-led status-led-offline"; 
        });

        client.on('offline', function () {
            console.log("Client ist offline.");
            mqttStatusLabelElement.textContent = "Offline"; 
            mqttLedElement.className = "status-led status-led-offline"; 
        });
    }

    // Starten der Verbindung und Zuweisen der Event-Handler
    document.addEventListener('DOMContentLoaded', function() {
        connectClient();

        // 1. Licht Steuerung
        document.getElementById("btnMainLightOn").onclick = function() {
            sendCommand(LIGHT_SET_TOPIC, "ON");
        };
        document.getElementById("btnMainLightOff").onclick = function() {
            sendCommand(LIGHT_SET_TOPIC, "OFF");
        };

        // 2. Heizung Setpoint und Presets
        document.getElementById("btnSetTemp").onclick = function() {
            const selectedTemp = document.getElementById("tempSetpoint").value;
            sendCommand(SETPOINT_SET_TOPIC, selectedTemp);
        };
        
        // NEU: Preset Buttons Logik
        document.querySelectorAll('.btn-preset').forEach(button => {
            button.onclick = function() {
                const temp = this.getAttribute('data-temp');
                document.getElementById("tempSetpoint").value = temp; // Optional: Setzt den Wert im Eingabefeld
                sendCommand(SETPOINT_SET_TOPIC, temp); // Sendet den Befehl
            };
        });
        
        // 3. MaxxFan Schalter
        switchAutoFan.onchange = function() {
            const state = this.checked ? "ON" : "OFF";
            sendCommand(MAXXFAN_AUTO_COMMAND_TOPIC, state);
            
            // Logik: Deaktiviert Ceiling Mode wenn Auto AN
            if (this.checked) {
                 if (switchCeilingMode.checked) sendCommand(MAXXFAN_CEILING_COMMAND_TOPIC, "OFF");
                 switchCeilingMode.checked = false;
            }
        }
        
        switchCeilingMode.onchange = function() {
            const state = this.checked ? "ON" : "OFF";
            sendCommand(MAXXFAN_CEILING_COMMAND_TOPIC, state);
            
            // Logik: Deaktiviert Auto Mode wenn Ceiling Mode AN
            if (this.checked) {
                if (switchAutoFan.checked) sendCommand(MAXXFAN_AUTO_COMMAND_TOPIC, "OFF");
                switchAutoFan.checked = false;
            }
        }

        // 4. Restart-Buttons zuweisen (OHNE CONFIRM)
        setupRestartButton("btnRestartHeater", RESTART_HEATER_TOPIC, "Heizung");
        setupRestartButton("btnRestartFan", RESTART_FAN_TOPIC, "MaxxFan");
        setupRestartButton("btnRestartGps", RESTART_GPS_TOPIC, "GPS/Lage");
        setupRestartButton("btnRestartTemp", RESTART_TEMP_TOPIC, "Temp/Licht");
        setupRestartButton("btnRestartWater", RESTART_WATER_TOPIC, "Wasser");
    });

</script>
</body>
</html>